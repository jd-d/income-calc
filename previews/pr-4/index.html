<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="icon" href="assets/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/favicon.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@500;600&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <title>Income Planner</title>
  <script src="pwa.js" defer></script>
  <style>
    :root {
      color-scheme: dark;
      --bg-gradient: radial-gradient(circle at top left, #161b2c, #0b1020 58%, #070b16 100%);
      --font-body: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-heading: "Clash Display", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --card-bg: rgba(16, 21, 36, 0.92);
      --card-border: rgba(255, 255, 255, 0.08);
      --card-surface: linear-gradient(160deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
      --card-shadow: 0 22px 48px rgba(0, 0, 0, 0.45);
      --text-primary: #f6f7fb;
      --text-muted: #b5bed3;
      --accent: #5aa9ff;
      --accent-soft: rgba(90, 169, 255, 0.12);
      --accent-border: rgba(90, 169, 255, 0.5);
      --surface-overlay: rgba(255, 255, 255, 0.06);
      --chip-bg: rgba(255, 255, 255, 0.08);
      --chip-border: rgba(255, 255, 255, 0.18);
      --field-bg: rgba(7, 11, 22, 0.75);
      --field-border: rgba(255, 255, 255, 0.14);
      --field-focus: rgba(90, 169, 255, 0.4);
      --focus-ring: rgba(90, 169, 255, 0.25);
      --status-error: #ff7b7b;
      --status-bg: rgba(255, 123, 123, 0.12);
      --table-border: rgba(255, 255, 255, 0.08);
      --table-header: rgba(255, 255, 255, 0.06);
      --positive: #34d399;
      --negative: #f87171;
    }

    body[data-theme="light"] {
      color-scheme: light;
      --bg-gradient: radial-gradient(circle at top left, #f3f6ff, #dbe6ff 58%, #d1dcff 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-border: rgba(15, 23, 42, 0.12);
      --card-surface: linear-gradient(160deg, rgba(15, 23, 42, 0.06), rgba(15, 23, 42, 0));
      --card-shadow: 0 18px 42px rgba(15, 23, 42, 0.12);
      --text-primary: #101827;
      --text-muted: #4c5664;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --accent-border: rgba(37, 99, 235, 0.35);
      --surface-overlay: rgba(15, 23, 42, 0.05);
      --chip-bg: rgba(15, 23, 42, 0.06);
      --chip-border: rgba(15, 23, 42, 0.12);
      --field-bg: rgba(240, 244, 255, 0.9);
      --field-border: rgba(15, 23, 42, 0.15);
      --field-focus: rgba(37, 99, 235, 0.25);
      --focus-ring: rgba(37, 99, 235, 0.18);
      --status-error: #dc2626;
      --status-bg: rgba(220, 38, 38, 0.12);
      --table-border: rgba(15, 23, 42, 0.08);
      --table-header: rgba(37, 99, 235, 0.12);
      --positive: #059669;
      --negative: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-body);
      line-height: 1.6;
      background: var(--bg-gradient);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      transition: background 0.4s ease, color 0.4s ease;
    }

    a {
      color: inherit;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .page {
      width: min(1100px, 94vw);
      margin: 0 auto;
      padding: clamp(24px, 6vw, 48px) 0 96px;
      padding-top: calc(clamp(24px, 6vw, 48px) + env(safe-area-inset-top, 0px));
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: clamp(28px, 5vw, 48px);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .top-links {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .top-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent-border);
      background: var(--accent-soft);
      text-decoration: none;
      font-size: 0.95rem;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .top-link:hover,
    .top-link:focus-visible {
      background: rgba(90, 169, 255, 0.18);
      transform: translateY(-1px);
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    body[data-theme="light"] .top-link:hover,
    body[data-theme="light"] .top-link:focus-visible {
      background: rgba(37, 99, 235, 0.18);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent-border);
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .theme-toggle:hover,
    .theme-toggle:focus-visible {
      transform: translateY(-1px);
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .hero {
      display: grid;
      gap: 18px;
    }

    .hero-title {
      margin: 0;
      font-family: var(--font-heading);
      font-weight: 600;
      font-size: clamp(2.1rem, 6vw, 3.15rem);
      letter-spacing: -0.01em;
    }

    .hero-description {
      margin: 0;
      font-size: 1.05rem;
      color: var(--text-muted);
      max-width: 60ch;
    }

    .layout {
      display: grid;
      gap: clamp(24px, 4vw, 36px);
    }

    @media (min-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
        align-items: start;
      }
    }

    .card {
      position: relative;
      background: var(--card-bg);
      border-radius: 24px;
      border: 1px solid var(--card-border);
      box-shadow: var(--card-shadow);
      padding: clamp(20px, 4vw, 28px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--card-surface);
      pointer-events: none;
      opacity: 0.9;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .section-title {
      font-family: var(--font-heading);
      font-size: 1.35rem;
      margin: 0;
    }

    .field-group {
      display: grid;
      gap: 16px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .field-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    input[type="number"],
    input[type="text"] {
      appearance: none;
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      border-radius: 14px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--field-focus);
    }

    .inputs-footer {
      display: grid;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .summary-grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 960px) {
      .summary-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .summary-card {
      background: var(--surface-overlay);
      border-radius: 18px;
      padding: 16px;
      border: 1px solid var(--table-border);
      display: grid;
      gap: 6px;
      min-height: 110px;
    }

    .summary-label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 1.15rem;
      font-weight: 600;
      font-family: var(--font-heading);
    }

    .table-section {
      display: grid;
      gap: 18px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .table-title {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid var(--table-border);
      background: var(--surface-overlay);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }

    thead tr {
      background: var(--table-header);
    }

    th,
    td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--table-border);
      font-size: 0.95rem;
      white-space: nowrap;
    }

    th.numeric,
    td.numeric {
      text-align: right;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status-message {
      margin: 0;
      font-size: 0.9rem;
      color: var(--status-error);
      background: var(--status-bg);
      border: 1px solid var(--status-error);
      border-radius: 14px;
      padding: 10px 14px;
      display: none;
    }

    .status-message[aria-hidden="false"] {
      display: block;
    }

    .delta-positive {
      color: var(--positive);
      font-weight: 600;
    }

    .delta-negative {
      color: var(--negative);
      font-weight: 600;
    }

    .footer-note {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    footer {
      width: min(1100px, 94vw);
      margin: 24px auto 32px;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="page">
    <div class="top-bar">
      <div class="top-links">
        <a class="top-link" href="resources.html">Helpful resources</a>
      </div>
      <button type="button" class="theme-toggle" id="theme-toggle" aria-pressed="true">
        <span aria-hidden="true">☾</span>
        <span id="theme-toggle-label">Dark mode</span>
      </button>
    </div>

    <header class="hero">
      <h1 class="hero-title">Plan your freelance income with confidence</h1>
      <p class="hero-description">
        Enter the income you want to take home, your tax rate, recurring costs, and how many hours you can bill.
        The calculator shows the hourly rate you need and how different rates translate to real net income.
      </p>
    </header>

    <main class="layout">
      <section class="card" aria-labelledby="inputs-heading">
        <h2 class="section-title" id="inputs-heading">Inputs</h2>
        <div class="field-group" role="group" aria-labelledby="income-heading">
          <div class="field">
            <label for="currency-symbol">Currency symbol</label>
            <input type="text" id="currency-symbol" value="€" maxlength="3" autocomplete="off" />
          </div>
          <div class="field">
            <label for="target-net">Desired take-home income per month</label>
            <input type="number" id="target-net" value="4500" min="0" step="50" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="savings-margin">Savings margin (%)</label>
            <input type="number" id="savings-margin" value="12" min="0" max="100" step="1" inputmode="decimal" />
            <p class="field-description">Extra cushion applied to your net goal before taxes are calculated.</p>
          </div>
        </div>

        <div class="field-group" role="group" aria-labelledby="schedule-heading">
          <div class="field">
            <label for="working-weeks">Billable weeks per year</label>
            <input type="number" id="working-weeks" value="46" min="1" max="52" step="1" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="billable-hours">Billable hours per week (comma separated)</label>
            <input type="text" id="billable-hours" value="10, 15, 20, 25, 30" autocomplete="off" />
            <p class="field-description">Used to build the hourly rate requirement table.</p>
          </div>
          <div class="field">
            <label for="typical-hours">Typical billable hours per week</label>
            <input type="number" id="typical-hours" value="22" min="1" max="80" step="1" inputmode="decimal" />
            <p class="field-description">Applied to the hourly rate comparison table below.</p>
          </div>
        </div>

        <div class="field-group" role="group" aria-labelledby="costs-heading">
          <div class="field">
            <label for="monthly-costs">Monthly operating costs</label>
            <input type="number" id="monthly-costs" value="650" min="0" step="50" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="tax-rate">Effective tax rate (%)</label>
            <input type="number" id="tax-rate" value="32" min="0" max="99" step="1" inputmode="decimal" />
            <p class="field-description">Combined income tax and national insurance you expect to pay on profit.</p>
          </div>
          <div class="field">
            <label for="hourly-rates">Hourly rate checkpoints</label>
            <input type="text" id="hourly-rates" value="55, 65, 75, 90, 110" autocomplete="off" />
            <p class="field-description">Compare what these rates deliver after tax and costs.</p>
          </div>
        </div>

        <p class="inputs-footer">
          Figures stay on this device only. Adjust any input to immediately update the projections.
        </p>
      </section>

      <section class="card" aria-labelledby="results-heading">
        <h2 class="section-title" id="results-heading">Results</h2>
        <div class="summary-grid" role="group" aria-label="Key metrics">
          <div class="summary-card">
            <span class="summary-label">Annual take-home goal</span>
            <span class="summary-value" id="net-annual">€54,000</span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Annual savings cushion</span>
            <span class="summary-value" id="margin-annual">€6,480</span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Annual operating costs</span>
            <span class="summary-value" id="overhead-annual">€7,800</span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Gross revenue required</span>
            <span class="summary-value" id="gross-annual">€101,147</span>
          </div>
        </div>

        <p class="status-message" id="status-message" aria-live="polite" aria-hidden="true"></p>

        <div class="table-section">
          <div class="table-header">
            <h3 class="table-title">Hourly rate required for your goal</h3>
          </div>
          <div class="table-wrapper" role="region" aria-live="polite" aria-labelledby="requirements-heading">
            <table aria-describedby="requirements-caption">
              <caption id="requirements-caption" class="visually-hidden">
                Required hourly rate for the desired net income at different billable hour scenarios.
              </caption>
              <thead>
                <tr>
                  <th scope="col">Billable hours / week</th>
                  <th scope="col" class="numeric">Billable hours / year</th>
                  <th scope="col" class="numeric">Required hourly rate</th>
                  <th scope="col" class="numeric">Gross revenue / month</th>
                  <th scope="col" class="numeric">Take-home / month</th>
                </tr>
              </thead>
              <tbody id="requirements-body"></tbody>
            </table>
          </div>
        </div>

        <div class="table-section">
          <div class="table-header">
            <h3 class="table-title">Net income at selected hourly rates</h3>
          </div>
          <div class="table-wrapper" role="region" aria-live="polite" aria-labelledby="comparison-heading">
            <table aria-describedby="comparison-caption">
              <caption id="comparison-caption" class="visually-hidden">
                Net income impact of the selected hourly rates using your typical billable hours.
              </caption>
              <thead>
                <tr>
                  <th scope="col">Hourly rate</th>
                  <th scope="col" class="numeric">Annual revenue</th>
                  <th scope="col" class="numeric">Net after tax &amp; costs (annual)</th>
                  <th scope="col" class="numeric">Net per month</th>
                  <th scope="col" class="numeric">Gap vs goal / month</th>
                </tr>
              </thead>
              <tbody id="comparison-body"></tbody>
            </table>
          </div>
        </div>

        <p class="footer-note">
          Calculations assume costs are deductible before tax. Net figures are rounded to the nearest whole currency unit for clarity.
        </p>
      </section>
    </main>
  </div>

  <footer>
    Built for independent professionals planning stable, sustainable incomes.
  </footer>

  <script>
    (function () {
      const THEME_STORAGE_KEY = 'income-calculator-theme';
      const themeToggle = document.getElementById('theme-toggle');
      const themeToggleLabel = document.getElementById('theme-toggle-label');

      function resolvePreferredTheme() {
        const prefersDark = typeof window.matchMedia === 'function'
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : true;
        try {
          const stored = localStorage.getItem(THEME_STORAGE_KEY);
          if (stored === 'light' || stored === 'dark') {
            return stored;
          }
        } catch (error) {
          // Ignore storage errors and fall back to system preference.
        }
        return prefersDark ? 'dark' : 'light';
      }

      function applyTheme(nextTheme) {
        const normalized = nextTheme === 'light' ? 'light' : 'dark';
        document.body.dataset.theme = normalized;
        if (themeToggle) {
          themeToggle.setAttribute('aria-pressed', normalized === 'dark' ? 'true' : 'false');
        }
        if (themeToggleLabel) {
          themeToggleLabel.textContent = normalized === 'dark' ? 'Dark mode' : 'Light mode';
        }
        try {
          localStorage.setItem(THEME_STORAGE_KEY, normalized);
        } catch (error) {
          // Ignore write errors (e.g., Safari private mode).
        }
        document.dispatchEvent(new CustomEvent('themechange', { detail: normalized }));
      }

      applyTheme(resolvePreferredTheme());

      themeToggle?.addEventListener('click', () => {
        const current = document.body.dataset.theme === 'light' ? 'light' : 'dark';
        applyTheme(current === 'light' ? 'dark' : 'light');
      });
    })();

    (function () {
      const fields = {
        currency: document.getElementById('currency-symbol'),
        targetNetMonthly: document.getElementById('target-net'),
        savingsMargin: document.getElementById('savings-margin'),
        workingWeeks: document.getElementById('working-weeks'),
        billableHours: document.getElementById('billable-hours'),
        typicalHours: document.getElementById('typical-hours'),
        monthlyCosts: document.getElementById('monthly-costs'),
        taxRate: document.getElementById('tax-rate'),
        hourlyRates: document.getElementById('hourly-rates')
      };

      const outputs = {
        netAnnual: document.getElementById('net-annual'),
        marginAnnual: document.getElementById('margin-annual'),
        overheadAnnual: document.getElementById('overhead-annual'),
        grossAnnual: document.getElementById('gross-annual'),
        status: document.getElementById('status-message'),
        requirementsBody: document.getElementById('requirements-body'),
        comparisonBody: document.getElementById('comparison-body')
      };

      const numberFormatter = new Intl.NumberFormat('en-US', {
        maximumFractionDigits: 0
      });

      function parseNumber(value, fallback = 0) {
        if (value === null || value === undefined) {
          return fallback;
        }
        const parsed = Number.parseFloat(String(value).replace(/,/g, '.'));
        return Number.isFinite(parsed) ? parsed : fallback;
      }

      function parseNumberList(value) {
        if (typeof value !== 'string') {
          return [];
        }
        return value
          .split(/[,\n]/)
          .map(entry => parseNumber(entry.trim(), NaN))
          .filter(item => Number.isFinite(item) && item > 0);
      }

      function formatCurrency(symbol, value, fractionDigits = 2) {
        if (!Number.isFinite(value)) {
          return '—';
        }
        const absolute = Math.abs(value);
        const formatted = absolute.toLocaleString('en-US', {
          minimumFractionDigits: fractionDigits,
          maximumFractionDigits: fractionDigits
        });
        if (value < 0) {
          return `-${symbol}${formatted}`;
        }
        return `${symbol}${formatted}`;
      }

      function formatInteger(value) {
        if (!Number.isFinite(value)) {
          return '—';
        }
        return numberFormatter.format(Math.round(value));
      }

      function setStatus(message) {
        if (!outputs.status) {
          return;
        }
        if (message) {
          outputs.status.textContent = message;
          outputs.status.setAttribute('aria-hidden', 'false');
        } else {
          outputs.status.textContent = '';
          outputs.status.setAttribute('aria-hidden', 'true');
        }
      }

      function buildRequirementsTable({
        currency,
        grossAnnual,
        netMonthly,
        workingWeeks,
        billableHourOptions
      }) {
        const body = outputs.requirementsBody;
        if (!body) {
          return;
        }
        body.innerHTML = '';

        if (!billableHourOptions.length || !Number.isFinite(grossAnnual) || grossAnnual <= 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Add billable hour scenarios to see the required hourly rate.';
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        billableHourOptions
          .slice()
          .sort((a, b) => a - b)
          .forEach(hoursPerWeek => {
            const hoursPerYear = hoursPerWeek * workingWeeks;
            const requiredHourlyRate = hoursPerYear > 0 ? grossAnnual / hoursPerYear : NaN;
            const grossMonthly = grossAnnual / 12;
            const row = document.createElement('tr');

            const columns = [
              hoursPerWeek.toFixed(1).replace(/\.0$/, ''),
              formatInteger(hoursPerYear),
              formatCurrency(currency, requiredHourlyRate, 2),
              formatCurrency(currency, grossMonthly, 0),
              formatCurrency(currency, netMonthly, 0)
            ];

            columns.forEach((value, index) => {
              const cell = document.createElement('td');
              cell.textContent = value;
              if (index > 0) {
                cell.className = 'numeric';
              }
              row.appendChild(cell);
            });
            fragment.appendChild(row);
          });

        body.appendChild(fragment);
      }

      function buildComparisonTable({
        currency,
        workingWeeks,
        typicalHours,
        taxRate,
        monthlyCosts,
        netMonthlyTarget,
        hourlyRateOptions
      }) {
        const body = outputs.comparisonBody;
        if (!body) {
          return;
        }
        body.innerHTML = '';

        if (!hourlyRateOptions.length || typicalHours <= 0 || workingWeeks <= 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = 'Enter hourly rate checkpoints and typical billable hours to compare outcomes.';
          row.appendChild(cell);
          body.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        const annualCosts = monthlyCosts * 12;
        const taxFraction = Math.max(Math.min(taxRate / 100, 0.99), 0);
        const netTargetMonthly = netMonthlyTarget;

        hourlyRateOptions
          .slice()
          .sort((a, b) => a - b)
          .forEach(rate => {
            const annualRevenue = rate * typicalHours * workingWeeks;
            const profitBeforeTax = annualRevenue - annualCosts;
            const netAfterTax = Math.max(profitBeforeTax * (1 - taxFraction), 0);
            const netMonthly = netAfterTax / 12;
            const gapMonthly = netMonthly - netTargetMonthly;

            const row = document.createElement('tr');
            const columns = [
              formatCurrency(currency, rate, 2),
              formatCurrency(currency, annualRevenue, 0),
              formatCurrency(currency, netAfterTax, 0),
              formatCurrency(currency, netMonthly, 0)
            ];

            columns.forEach((value, index) => {
              const cell = document.createElement('td');
              cell.textContent = value;
              if (index > 0) {
                cell.className = 'numeric';
              }
              row.appendChild(cell);
            });

            const deltaCell = document.createElement('td');
            deltaCell.className = 'numeric';
            const fractionDigits = Math.abs(gapMonthly) < 1 ? 2 : 0;
            deltaCell.textContent = formatCurrency(currency, gapMonthly, fractionDigits);
            deltaCell.classList.add(gapMonthly >= 0 ? 'delta-positive' : 'delta-negative');
            row.appendChild(deltaCell);

            fragment.appendChild(row);
          });

        body.appendChild(fragment);
      }

      function render() {
        const currencySymbol = (fields.currency?.value || '€').trim() || '€';
        const netMonthlyTarget = Math.max(parseNumber(fields.targetNetMonthly?.value, 0), 0);
        const savingsMargin = Math.max(parseNumber(fields.savingsMargin?.value, 0), 0);
        const workingWeeks = Math.min(Math.max(parseNumber(fields.workingWeeks?.value, 46), 1), 52);
        const billableHourOptions = parseNumberList(fields.billableHours?.value || '');
        const typicalHours = Math.max(parseNumber(fields.typicalHours?.value, 0), 0);
        const monthlyCosts = Math.max(parseNumber(fields.monthlyCosts?.value, 0), 0);
        const taxRate = Math.max(parseNumber(fields.taxRate?.value, 0), 0);
        const hourlyRateOptions = parseNumberList(fields.hourlyRates?.value || '');

        const netAnnual = netMonthlyTarget * 12;
        const marginAnnual = netAnnual * (savingsMargin / 100);
        const overheadAnnual = monthlyCosts * 12;
        const taxFraction = Math.max(Math.min(taxRate / 100, 0.95), 0);

        const grossAnnual = (netAnnual + marginAnnual + overheadAnnual) / (1 - taxFraction || 1);

        if (outputs.netAnnual) {
          outputs.netAnnual.textContent = formatCurrency(currencySymbol, netAnnual, 0);
        }
        if (outputs.marginAnnual) {
          outputs.marginAnnual.textContent = formatCurrency(currencySymbol, marginAnnual, 0);
        }
        if (outputs.overheadAnnual) {
          outputs.overheadAnnual.textContent = formatCurrency(currencySymbol, overheadAnnual, 0);
        }
        if (outputs.grossAnnual) {
          outputs.grossAnnual.textContent = formatCurrency(currencySymbol, grossAnnual, 0);
        }

        if (taxRate >= 95) {
          setStatus('Effective tax rate is extremely high. Lower it below 95% to get realistic projections.');
        } else if (!billableHourOptions.length) {
          setStatus('Enter at least one billable hours per week value to populate the required rate table.');
        } else {
          setStatus('');
        }

        buildRequirementsTable({
          currency: currencySymbol,
          grossAnnual,
          netMonthly: netMonthlyTarget,
          workingWeeks,
          billableHourOptions
        });

        buildComparisonTable({
          currency: currencySymbol,
          workingWeeks,
          typicalHours,
          taxRate,
          monthlyCosts,
          netMonthlyTarget,
          hourlyRateOptions
        });
      }

      Object.values(fields).forEach(field => {
        if (!field) {
          return;
        }
        field.addEventListener('input', render);
        field.addEventListener('change', render);
      });

      render();
    })();
  </script>
</body>
</html>
